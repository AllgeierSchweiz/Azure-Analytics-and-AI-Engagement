{
   "$schema":"https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
   "contentVersion":"1.0.0.0",
   "parameters":{
      "workspace_name_synapseretail":{
         "type":"String",
         "metadata":{
            "description":""
         }
      },
      "storage_account_name":{
        "type":"String",
        "metadata":{
           "description":""
        }
     },
     "sql_administrator_login_password":{
        "type":"String",
        "metadata":{
           "description":""
        }
     },
     "key_vault_name":{
        "type":"String",
        "metadata":{
           "description":""
        }
     },
     "location":{
         "type":"String",
         "metadata":{
            "description":""
         }
      }
   },
   "variables":{
      "sql_compute_name":"RetailDW",
      "sql_administrator_login_id":"labsqladmin",
      "spark_compute_name":"Retail",
      "sql_server_sku":"DW100c",
      "spark_auto_scale_enabled":"true",
      "spark_min_node_count":"3",
      "spark_max_node_count":"20",
      "spark_node_count":"1",
      "spark_node_size_family":"MemoryOptimized",
      "spark_node_size":"Large",
      "spark_auto_pause_enabled":"true",
      "spark_auto_pause_delay_in_minutes":"5",
      "spark_version":"2.4",
      "default_data_lake_storage_file_system_name":"retail-data",
      "default_data_lake_storage_account_url":"[concat('https://', parameters('storage_account_name'), '.dfs.core.windows.net')]"
   },
   "resources":[
      {
         "type":"Microsoft.KeyVault/vaults",
         "name":"[parameters('key_vault_name')]",
         "apiVersion":"2018-02-14",
         "location":"[parameters('location')]",
         "properties":{
            "enabledForDeployment":true,
            "enabledForDiskEncryption":true,
            "enabledForTemplateDeployment":true,
            "vaultUri":"[concat('https://', parameters('key_vault_name'), '.vault.azure.net/')]",
            "tenantId":"[subscription().tenantId]",
            "accessPolicies":[
               
            ],
            "sku":{
               "name":"Standard",
               "family":"A"
            },
            "networkAcls":{
               "defaultAction":"Allow",
               "bypass":"AzureServices"
            }
         }
      },
      {
         "type":"Microsoft.KeyVault/vaults/secrets",
         "name":"[concat(parameters('key_vault_name'), '/SqlPassword')]",
         "apiVersion":"2018-02-14",
         "location":"[parameters('location')]",
         "dependsOn":[
            "[resourceId('Microsoft.KeyVault/vaults', parameters('key_vault_name'))]"
         ],
         "properties":{
            "value":"[parameters('sql_administrator_login_password')]"
         }
      },
      {
         "name":"[parameters('workspace_name_synapseretail')]",
         "type":"Microsoft.Synapse/workspaces",
         "apiVersion":"2021-05-01",
         "location":"[parameters('location')]",
         "identity":{
            "type":"SystemAssigned"
         },
         "properties":{
            "defaultDataLakeStorage":{
               "accountUrl":"[variables('default_data_lake_storage_account_url')]",
               "filesystem":"[variables('default_data_lake_storage_file_system_name')]"
            },
            "sqlAdministratorLogin":"[variables('sql_administrator_login_id')]",
            "sqlAdministratorLoginPassword":"[parameters('sql_administrator_login_password')]"
         },
         "resources":[
            {
               "type":"firewallrules",
               "apiVersion":"2021-05-01",
               "name":"allowAll",
               "location":"[parameters('location')]",
               "dependsOn":[
                  "[resourceId('Microsoft.Synapse/workspaces', parameters('workspace_name_synapseretail'))]"
               ],
               "properties":{
                  "startIpAddress":"0.0.0.0",
                  "endIpAddress":"255.255.255.255"
               }
            }
         ]
      },
      {
         "name":"[concat(parameters('workspace_name_synapseretail'), '/', variables('spark_compute_name'))]",
         "type":"Microsoft.Synapse/workspaces/bigDataPools",
         "apiVersion":"2021-05-01",
         "location":"[parameters('location')]",
         "dependsOn":[
            "[resourceId('Microsoft.Synapse/workspaces', parameters('workspace_name_synapseretail'))]"
         ],
         "properties":{
            "nodeCount":"[variables('spark_node_count')]",
            "nodeSizeFamily":"[variables('spark_node_size_family')]",
            "nodeSize":"[variables('spark_node_size')]",
            "autoScale":{
               "enabled":"[variables('spark_auto_scale_enabled')]",
               "minNodeCount":"[variables('spark_min_node_count')]",
               "maxNodeCount":"[variables('spark_max_node_count')]"
            },
            "autoPause":{
               "enabled":"[variables('spark_auto_pause_enabled')]",
               "delayInMinutes":"[variables('spark_auto_pause_delay_in_minutes')]"
            },
            "sparkVersion":"[variables('spark_version')]"
         }
      },
      {
         "name":"[concat(parameters('workspace_name_synapseretail'), '/', variables('sql_compute_name'))]",
         "type":"Microsoft.Synapse/workspaces/sqlPools",
         "apiVersion":"2021-05-01",
         "location":"[parameters('location')]",
         "dependsOn":[
            "[resourceId('Microsoft.Synapse/workspaces', parameters('workspace_name_synapseretail'))]"
         ],
         "sku":{
            "name":"[variables('sql_server_sku')]"
         },
         "properties":{
            "createMode":"Default",
            "collation":"SQL_Latin1_General_CP1_CI_AS"
         }
      }
   ],
   "outputs":{
      
   }
}